<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Edit Labels - {{ stem }}</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 1rem; }
      .nav { position: sticky; top: 0; background: #fff; border-bottom: 1px solid #e5e7eb; padding: .6rem 1rem; margin: -1rem -1rem 1rem -1rem; z-index: 10; display:flex; gap:1rem; }
      .nav a { text-decoration: none; color: #2563eb; font-weight: 600; }
      .flash { background: #fff3cd; padding: .5rem .75rem; border: 1px solid #ffeeba; margin-bottom: 1rem; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #e5e7eb; padding: .4rem .5rem; font-size: 14px; }
      th { background: #f9fafb; text-align: left; }
      input[type=text] { width: 100%; padding: .35rem; }
      .toolbar { display:flex; gap: .75rem; align-items:center; margin: .5rem 0 1rem; }
      a { text-decoration: none; color: #2563eb; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
      .actions { position: sticky; top: 48px; background: #ffffff; border-bottom: 1px solid #e5e7eb; padding: .5rem; z-index: 9; display:flex; gap:.75rem; align-items:center; }
      .actions button { padding: .4rem .75rem; }
    </style>
  </head>
  <body>
    <div class="nav">
      <a href="{{ url_for('index') }}">Upload</a>
      <a href="{{ url_for('curated') }}">Curated</a>
    </div>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        {% for m in messages %}<div class="flash">{{ m }}</div>{% endfor %}
      {% endif %}
    {% endwith %}

    <div class="toolbar">
      <a href="{{ url_for('index') }}">‚Üê Upload another</a>
      <a class="mono" href="{{ url_for('download', filename=download_name) }}">Download JSON</a>
    </div>

    <div class="actions">
      <button type="submit" form="editForm">Save All Changes</button>
      <button type="button" onclick="restoreAll()">Restore Defaults</button>
      <button type="button" onclick="curateAll()">Curate All</button>
    </div>

    <h2>Edit Labels: {{ mapping.document }}</h2>
    <form id="editForm" method="post">
      <table>
        <thead>
          <tr>
            <th>Page</th>
            <th>Label</th>
            <th>Auto Label</th>
            <th>Raw Label</th>
            <th>Multipage</th>
            <th>Updated?</th>
            <th>Edit Label</th>
            <th>Action</th>
            <th>View</th>
            <th>Curate</th>
            <th>Suggest</th>
          </tr>
        </thead>
        <tbody>
        {% for p in mapping.pages %}
          <tr>
            <td>{{ p.page }}</td>
            <td class="mono">{{ p.label }}</td>
            <td class="mono">{{ p.auto_label }}</td>
            <td class="mono">{{ p.raw_label }}</td>
            <td>{{ '‚úî' if p.multipage else '' }}</td>
            <td>{{ '‚úî' if p.updated_label else '' }}</td>
            <td><input type="text" name="label_{{ p.page }}" id="label_{{ p.page }}" value="{{ p.label }}" /></td>
            <td>
              <button type="button" onclick="saveRow({{ p.page }})">Save</button>
              <button type="button" onclick="restoreRow({{ p.page }})">Restore Default</button>
            </td>
            <td style="text-align:center">
              <a title="Preview page {{ p.page }}" target="_blank" rel="noopener"
                 href="{{ url_for('serve_pdf', filename=mapping.document) }}#page={{ p.page }}">üîç</a>
            </td>
            <td style="text-align:center">
              <button type="button" onclick="curateRow({{ p.page }})">Curate</button>
            </td>
            <td style="text-align:center">
              <button type="button" onclick="suggestRow({{ p.page }})">Suggest</button>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      
    </form>

    <script>
      async function saveRow(page) {
        const input = document.getElementById('label_' + page);
        const label = input ? input.value : '';
        try {
          const res = await fetch('{{ url_for('api_update_label', stem=stem, page=0) }}?name={{ download_name }}'.replace('/0','/' + page), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ label })
          });
          const data = await res.json();
          if (!data.ok) {
            alert('Save failed: ' + (data.error || res.status));
          } else {
            // Light feedback
            input.style.backgroundColor = '#e6fffa';
            setTimeout(() => input.style.backgroundColor = '', 500);
            // Optionally, refresh to update multipage flags; keeping light here
          }
        } catch (e) {
          alert('Save error');
        }
      }

      async function restoreRow(page) {
        const input = document.getElementById('label_' + page);
        try {
          const res = await fetch('{{ url_for('api_restore_label', stem=stem, page=0) }}?name={{ download_name }}'.replace('/0','/' + page), {
            method: 'POST'
          });
          const data = await res.json();
          if (!data.ok) {
            alert('Restore failed: ' + (data.error || res.status));
          } else {
            if (input) input.value = data.label;
            location.reload();
          }
        } catch (e) {
          alert('Restore error');
        }
      }

      async function restoreAll() {
        try {
          const res = await fetch('{{ url_for('api_restore_all', stem=stem) }}?name={{ download_name }}', { method: 'POST' });
          const data = await res.json();
          if (!data.ok) {
            alert('Restore all failed: ' + (data.error || res.status));
          } else {
            location.reload();
          }
        } catch (e) {
          alert('Restore all error');
        }
      }

      async function curateRow(page) {
        try {
          const res = await fetch('{{ url_for('api_curate_page', stem=stem, page=0) }}?name={{ download_name }}'.replace('/0','/' + page), { method: 'POST' });
          const data = await res.json();
          if (!data.ok) {
            alert('Curate failed: ' + (data.error || res.status));
          } else {
            alert('Curated page ' + page);
          }
        } catch (e) {
          alert('Curate error');
        }
      }

      async function curateAll() {
        try {
          const res = await fetch('{{ url_for('api_curate_all', stem=stem) }}?name={{ download_name }}', { method: 'POST' });
          const data = await res.json();
          if (!data.ok) {
            alert('Curate all failed: ' + (data.error || res.status));
          } else {
            alert('Curated ' + (data.count || 0) + ' pages');
          }
        } catch (e) {
          alert('Curate all error');
        }
      }

      async function suggestRow(page) {
        try {
          const res = await fetch('{{ url_for('api_suggest', stem=stem, page=0) }}?name={{ download_name }}'.replace('/0','/' + page));
          const data = await res.json();
          if (!data.ok) {
            alert('Suggest failed: ' + (data.error || res.status));
            return;
          }
          const items = (data.results || []).map(r => `${r.rank}. ${r.label} (score ${r.score.toFixed(3)})`).join('\n');
          if (!items) {
            alert('No suggestions.');
            return;
          }
          const pick = prompt('Top suggestions:\n\n' + items + '\n\nType the number to apply:', '1');
          if (!pick) return;
          const n = parseInt(pick, 10);
          if (isNaN(n) || n < 1 || n > (data.results || []).length) return;
          const chosen = data.results[n - 1];
          const input = document.getElementById('label_' + page);
          if (input) input.value = chosen.label;
        } catch (e) {
          alert('Suggest error');
        }
      }
    </script>

    {% if mapping.bookmarks %}
      <h3>Original Bookmarks</h3>
      <table>
        <thead>
          <tr>
            <th>Page</th>
            <th>Bookmark Title</th>
          </tr>
        </thead>
        <tbody>
        {% for b in mapping.bookmarks %}
          <tr>
            <td>{{ b.page }}</td>
            <td class="mono">{{ b.label }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </body>
  </html>
