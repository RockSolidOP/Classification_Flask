<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Edit Labels - {{ stem }}</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 1rem; }
      .nav { position: sticky; top: 0; background: #fff; border-bottom: 1px solid #e5e7eb; padding: .6rem 1rem; margin: -1rem -1rem 1rem -1rem; z-index: 10; display:flex; gap:1rem; }
      .nav a { text-decoration: none; color: #2563eb; font-weight: 600; }
      .flash { background: #fff3cd; padding: .5rem .75rem; border: 1px solid #ffeeba; margin-bottom: 1rem; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #e5e7eb; padding: .4rem .5rem; font-size: 14px; }
      th { background: #f9fafb; text-align: left; }
      input[type=text] { width: 100%; padding: .35rem; }
      .toolbar { display:flex; gap: .75rem; align-items:center; margin: .5rem 0 1rem; }
      a { text-decoration: none; color: #2563eb; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
      .actions { position: sticky; top: 48px; background: #ffffff; border-bottom: 1px solid #e5e7eb; padding: .5rem; z-index: 9; display:flex; gap:.75rem; align-items:center; }
      .actions button { padding: .4rem .75rem; }
      .busy { display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); z-index:2000; align-items:center; justify-content:center; }
      .busy .box { background:#111827; color:#e5e7eb; padding:1rem 1.25rem; border-radius:10px; min-width:280px; text-align:center; box-shadow:0 10px 25px rgba(0,0,0,.3); }
      .spinner { width:28px; height:28px; border:3px solid #93c5fd; border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto .5rem auto; }
      @keyframes spin{to{transform:rotate(360deg)}}
    </style>
  </head>
  <body>
    <div class="nav">
      <a href="{{ url_for('index') }}" title="Upload a PDF and generate labels">Upload</a>
      <a href="{{ url_for('curated') }}" title="Review curated dataset, build embeddings, manage versions">Curated</a>
      <a href="{{ url_for('help_page') }}" title="How to use this app">Help</a>
    </div>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        {% for m in messages %}<div class="flash">{{ m }}</div>{% endfor %}
      {% endif %}
    {% endwith %}

    <div class="toolbar">
      <a href="{{ url_for('index') }}">‚Üê Upload another</a>
      <a class="mono" href="{{ url_for('download', filename=download_name) }}">Download JSON</a>
    </div>

    <div class="actions">
      <button type="submit" form="editForm" title="Save all label edits on this page to the JSON file">Save All Changes</button>
      <button type="button" onclick="restoreAll()" title="Restore all labels to auto_label (default)">Restore Defaults</button>
      <button type="button" onclick="curateAll()" title="Append all labeled pages to curated dataset">Curate All</button>
    </div>

    <h2>Edit Labels: {{ mapping.document }}</h2>
    <form id="editForm" method="post">
      <table>
        <thead>
          <tr>
            <th>Page</th>
            <th>Label</th>
            <th>Auto Label</th>
            <th>Raw Label</th>
            <th>Multipage</th>
            <th>Updated?</th>
            <th>Edit Label</th>
            <th>Action</th>
            <th>View</th>
            <th>Curate</th>
            <th>Suggest</th>
          </tr>
        </thead>
        <tbody>
        {% for p in mapping.pages %}
          <tr>
            <td>{{ p.page }}</td>
            <td class="mono">{{ p.label }}</td>
            <td class="mono">{{ p.auto_label }}</td>
            <td class="mono">{{ p.raw_label }}</td>
            <td>{{ '‚úî' if p.multipage else '' }}</td>
            <td>{{ '‚úî' if p.updated_label else '' }}</td>
            <td><input type="text" name="label_{{ p.page }}" id="label_{{ p.page }}" value="{{ p.label }}" title="Edit the label for this page" /></td>
            <td>
              <button type="button" onclick="saveRow({{ p.page }})" title="Save this label immediately">Save</button>
              <button type="button" onclick="restoreRow({{ p.page }})" title="Restore this page's label to auto_label">Restore Default</button>
            </td>
            <td style="text-align:center">
              <a title="Preview page {{ p.page }} in the PDF viewer" target="_blank" rel="noopener"
                 href="{{ url_for('serve_pdf', filename=mapping.document) }}#page={{ p.page }}">üîç</a>
            </td>
            <td style="text-align:center">
              <button type="button" onclick="curateRow({{ p.page }})" title="Append this page to curated dataset">Curate</button>
            </td>
            <td style="text-align:center">
              <button type="button" onclick="openSuggest({{ p.page }})" title="See suggested labels for this page">Suggest</button>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      
    </form>

    <script>
      // Busy overlay
      const busy = document.createElement('div');
      busy.className = 'busy';
      busy.innerHTML = '<div class="box"><div class="spinner"></div><div id="busyMsg">Working...</div></div>';
      document.body.appendChild(busy);
      function showBusy(msg){ const m=document.getElementById('busyMsg'); if(m) m.textContent = msg||'Working...'; busy.style.display='flex'; }
      function hideBusy(){ busy.style.display='none'; }
      async function saveRow(page) {
        showBusy('Saving...');
        const input = document.getElementById('label_' + page);
        const label = input ? input.value : '';
        try {
          const res = await fetch('{{ url_for('api_update_label', stem=stem, page=0) }}?name={{ download_name }}'.replace('/0','/' + page), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ label })
          });
          const data = await res.json();
          if (!data.ok) {
            alert('Save failed: ' + (data.error || res.status));
          } else {
            // Light feedback
            input.style.backgroundColor = '#e6fffa';
            setTimeout(() => input.style.backgroundColor = '', 500);
            // Optionally, refresh to update multipage flags; keeping light here
          }
        } catch (e) { alert('Save error'); }
        finally { hideBusy(); }
      }

      async function restoreRow(page) {
        showBusy('Restoring...');
        const input = document.getElementById('label_' + page);
        try {
          const res = await fetch('{{ url_for('api_restore_label', stem=stem, page=0) }}?name={{ download_name }}'.replace('/0','/' + page), {
            method: 'POST'
          });
          const data = await res.json();
          if (!data.ok) {
            alert('Restore failed: ' + (data.error || res.status));
          } else {
            if (input) input.value = data.label;
            location.reload();
          }
        } catch (e) { alert('Restore error'); }
        finally { hideBusy(); }
      }

      async function restoreAll() {
        showBusy('Restoring defaults...');
        try {
          const res = await fetch('{{ url_for('api_restore_all', stem=stem) }}?name={{ download_name }}', { method: 'POST' });
          const data = await res.json();
          if (!data.ok) {
            alert('Restore all failed: ' + (data.error || res.status));
          } else {
            location.reload();
          }
        } catch (e) { alert('Restore all error'); }
        finally { hideBusy(); }
      }

      async function curateRow(page) {
        showBusy('Curating...');
        try {
          const res = await fetch('{{ url_for('api_curate_page', stem=stem, page=0) }}?name={{ download_name }}'.replace('/0','/' + page), { method: 'POST' });
          const data = await res.json();
          if (!data.ok) {
            alert('Curate failed: ' + (data.error || res.status));
          } else {
            alert('Curated page ' + page);
          }
        } catch (e) { alert('Curate error'); }
        finally { hideBusy(); }
      }

      async function curateAll() {
        showBusy('Curating all pages...');
        try {
          const res = await fetch('{{ url_for('api_curate_all', stem=stem) }}?name={{ download_name }}', { method: 'POST' });
          const data = await res.json();
          if (!data.ok) {
            alert('Curate all failed: ' + (data.error || res.status));
          } else {
            alert('Curated ' + (data.count || 0) + ' pages');
          }
        } catch (e) { alert('Curate all error'); }
        finally { hideBusy(); }
      }

      // Suggest modal UI
      function openSuggest(page) {
        const overlay = document.getElementById('suggOverlay');
        const modal = document.getElementById('suggModal');
        document.getElementById('suggPage').value = page;
        document.getElementById('suggList').innerHTML = '<li>Loading...</li>';
        document.getElementById('suggAliasInfo').textContent = '';
        overlay.style.display = 'block';
        modal.style.display = 'block';
        fetch('{{ url_for('api_suggest', stem=stem, page=0) }}?name={{ download_name }}'.replace('/0','/' + page))
          .then(r => r.json()).then(data => {
            if (!data.ok) {
              document.getElementById('suggList').innerHTML = `<li>Error: ${data.error || 'not available'}</li>`;
              return;
            }
            const list = document.getElementById('suggList');
            list.innerHTML = '';
            (data.results || []).forEach((r, idx) => {
              const li = document.createElement('li');
              li.innerHTML = `<label><input type="radio" name="suggPick" value="${idx}" ${idx===0?'checked':''}/> ${r.label} <span style='color:#6b7280'>(score ${r.score.toFixed(3)})</span></label>`;
              list.appendChild(li);
            });
          }).catch(() => {
            document.getElementById('suggList').innerHTML = '<li>Error loading suggestions</li>';
          });
      }
      function closeSuggest() {
        document.getElementById('suggOverlay').style.display = 'none';
        document.getElementById('suggModal').style.display = 'none';
      }
      function getSelectedSuggestion() {
        const pick = document.querySelector('input[name="suggPick"]:checked');
        const page = parseInt(document.getElementById('suggPage').value, 10);
        return { pick: pick ? parseInt(pick.value,10) : 0, page };
      }
      function applySuggestion() {
        showBusy('Applying...');
        const { pick, page } = getSelectedSuggestion();
        const rowInput = document.getElementById('label_' + page);
        const labels = Array.from(document.querySelectorAll('#suggList label'));
        if (!labels[pick]) return;
        const text = labels[pick].innerText;
        const cand = text.split(' (score')[0];
        if (rowInput) rowInput.value = cand;
        closeSuggest(); hideBusy();
      }
      async function saveSuggestion() {
        showBusy('Saving...');
        const { pick, page } = getSelectedSuggestion();
        const labels = Array.from(document.querySelectorAll('#suggList label'));
        if (!labels[pick]) return;
        const cand = labels[pick].innerText.split(' (score')[0];
        const res = await fetch('{{ url_for('api_update_label', stem=stem, page=0) }}?name={{ download_name }}'.replace('/0','/' + page), {
          method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ label: cand })
        });
        const data = await res.json();
        if (!data.ok) return alert('Save failed: ' + (data.error||''));
        const rowInput = document.getElementById('label_' + page); if (rowInput) rowInput.value = cand;
        closeSuggest(); hideBusy();
        location.reload();
      }
      async function curateSuggestion() {
        showBusy('Saving and curating...');
        const { pick, page } = getSelectedSuggestion();
        const labels = Array.from(document.querySelectorAll('#suggList label'));
        if (!labels[pick]) return;
        const cand = labels[pick].innerText.split(' (score')[0];
        // save then curate
        const res = await fetch('{{ url_for('api_update_label', stem=stem, page=0) }}?name={{ download_name }}'.replace('/0','/' + page), {
          method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ label: cand })
        });
        const data = await res.json(); if (!data.ok) return alert('Save failed');
        const res2 = await fetch('{{ url_for('api_curate_page', stem=stem, page=0) }}?name={{ download_name }}'.replace('/0','/' + page), { method: 'POST' });
        const data2 = await res2.json(); if (!data2.ok) return alert('Curate failed: ' + (data2.error||''));
        const rowInput = document.getElementById('label_' + page); if (rowInput) rowInput.value = cand;
        closeSuggest(); hideBusy();
        alert('Saved and curated');
      }
      async function mergeAndCurate() {
        showBusy('Merging, saving and curating...');
        const { pick, page } = getSelectedSuggestion();
        const labels = Array.from(document.querySelectorAll('#suggList label'));
        if (!labels[pick]) return;
        const cand = labels[pick].innerText.split(' (score')[0];
        const current = (document.getElementById('label_' + page)?.value || '').trim();
        if (!current) return alert('No current label');
        // Merge alias mapping: current -> cand
        const m = await fetch('{{ url_for('api_label_alias_merge') }}', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ alias: current, canonical: cand }) });
        const md = await m.json(); if (!md.ok) return alert('Merge failed: ' + (md.error||''));
        // Apply and curate
        const res = await fetch('{{ url_for('api_update_label', stem=stem, page=0) }}?name={{ download_name }}'.replace('/0','/' + page), {
          method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ label: cand })
        });
        const data = await res.json(); if (!data.ok) return alert('Save failed');
        const res2 = await fetch('{{ url_for('api_curate_page', stem=stem, page=0) }}?name={{ download_name }}'.replace('/0','/' + page), { method: 'POST' });
        const data2 = await res2.json(); if (!data2.ok) return alert('Curate failed: ' + (data2.error||''));
        document.getElementById('label_' + page).value = cand;
        closeSuggest(); hideBusy();
        alert('Merged alias, saved, and curated');
      }
    </script>
    <div class="busy"><div class="box"><div class="spinner"></div><div id="busyMsg">Working...</div></div></div>

    <!-- Suggest Modal -->
    <div id="suggOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;"></div>
    <div id="suggModal" style="display:none;position:fixed;top:10%;left:50%;transform:translateX(-50%);background:#111827;color:#e5e7eb;padding:1rem 1.25rem;border-radius:10px;min-width:420px;z-index:1001;box-shadow:0 10px 25px rgba(0,0,0,.3);">
      <input type="hidden" id="suggPage" />
      <div style="font-weight:700;margin-bottom:.5rem;">Top suggestions</div>
      <ul id="suggList" style="list-style:none;padding:0;margin:0 0 .75rem 0;"></ul>
      <div id="suggAliasInfo" style="font-size:12px;color:#9ca3af;margin-bottom:.5rem;"></div>
      <div style="display:flex;gap:.5rem;justify-content:flex-end;">
        <button type="button" onclick="closeSuggest()" title="Close without applying any suggestion">Close</button>
        <button type="button" onclick="applySuggestion()" title="Fill the Edit Label field with the selected suggestion">Apply</button>
        <button type="button" onclick="saveSuggestion()" title="Apply and immediately save to the JSON file">Apply + Save</button>
        <button type="button" onclick="curateSuggestion()" title="Apply, save, and append/update one curated record for this page">Apply + Curate</button>
        <button type="button" onclick="mergeAndCurate()" title="Map current label to the selected canonical label, then apply, save, and curate">Merge Alias + Curate</button>
      </div>
    </div>

    {% if mapping.bookmarks %}
      <h3>Original Bookmarks</h3>
      <table>
        <thead>
          <tr>
            <th>Page</th>
            <th>Bookmark Title</th>
          </tr>
        </thead>
        <tbody>
        {% for b in mapping.bookmarks %}
          <tr>
            <td>{{ b.page }}</td>
            <td class="mono">{{ b.label }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </body>
  </html>
